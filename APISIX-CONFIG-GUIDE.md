# APISIX é…ç½®ç®¡ç†æŒ‡å—

## ğŸ“‹ ç›®å½•

1. [é—®é¢˜è§£ç­”](#é—®é¢˜è§£ç­”)
2. [é…ç½®ç®¡ç†æ–¹æ¡ˆ](#é…ç½®ç®¡ç†æ–¹æ¡ˆ)
3. [å¼€å‘ç¯å¢ƒå®è·µ](#å¼€å‘ç¯å¢ƒå®è·µ)
4. [ç”Ÿäº§ç¯å¢ƒå®è·µ](#ç”Ÿäº§ç¯å¢ƒå®è·µ)
5. [æœ€ä½³å®è·µå»ºè®®](#æœ€ä½³å®è·µå»ºè®®)

---

## é—®é¢˜è§£ç­”

### 1. Proto æ–‡ä»¶åº”è¯¥æ”¾åœ¨å“ªé‡Œï¼Ÿ

**ç­”æ¡ˆï¼šä¸¤ç§æ–¹æ¡ˆéƒ½å¯ä»¥ï¼Œå–å†³äºå›¢é˜Ÿåä½œæ–¹å¼**

#### æ–¹æ¡ˆ Aï¼šé›†ä¸­å¼ç®¡ç†ï¼ˆæ¨èç”¨äºå°å›¢é˜Ÿ/ç»Ÿä¸€å¼€å‘ï¼‰

```
é¡¹ç›®æ ¹ç›®å½•/
â”œâ”€â”€ proto/              # æ‰€æœ‰ proto æ–‡ä»¶é›†ä¸­ç®¡ç†
â”‚   â”œâ”€â”€ user.proto
â”‚   â”œâ”€â”€ order.proto
â”‚   â””â”€â”€ feed.proto
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ user-service/   # å¾®æœåŠ¡ Aï¼ˆç‹¬ç«‹ä»“åº“ï¼‰
â”‚   â””â”€â”€ order-service/  # å¾®æœåŠ¡ Bï¼ˆç‹¬ç«‹ä»“åº“ï¼‰
â””â”€â”€ apisix/
    â””â”€â”€ config/
```

**ä¼˜ç‚¹ï¼š**
- âœ… ç»Ÿä¸€ç®¡ç†ï¼Œé¿å…ç‰ˆæœ¬ä¸ä¸€è‡´
- âœ… ä¾¿äºè·¨æœåŠ¡ API åè°ƒ
- âœ… é…ç½®ç”Ÿæˆç®€å•

**ç¼ºç‚¹ï¼š**
- âŒ éœ€è¦ç‹¬ç«‹çš„ proto ä»“åº“æˆ–å­æ¨¡å—
- âŒ å¾®æœåŠ¡å›¢é˜Ÿéœ€è¦ç­‰å¾… proto æ›´æ–°

#### æ–¹æ¡ˆ Bï¼šåˆ†å¸ƒå¼ç®¡ç†ï¼ˆæ¨èç”¨äºå¤§å›¢é˜Ÿ/ç‹¬ç«‹å¼€å‘ï¼‰

```
user-service/          # ç‹¬ç«‹ä»“åº“
â”œâ”€â”€ proto/
â”‚   â””â”€â”€ user.proto     # æœåŠ¡è‡ªå·±çš„ proto
â”œâ”€â”€ api/
â””â”€â”€ internal/

order-service/         # ç‹¬ç«‹ä»“åº“
â”œâ”€â”€ proto/
â”‚   â””â”€â”€ order.proto
â”œâ”€â”€ api/
â””â”€â”€ internal/
```

**ä¼˜ç‚¹ï¼š**
- âœ… å¾®æœåŠ¡å®Œå…¨ç‹¬ç«‹ï¼Œè‡ªä¸»ç®¡ç† API
- âœ… å›¢é˜Ÿå¯ä»¥å¹¶è¡Œå¼€å‘
- âœ… ç¬¦åˆå¾®æœåŠ¡è‡ªæ²»åŸåˆ™

**ç¼ºç‚¹ï¼š**
- âŒ éœ€è¦åè°ƒæœºåˆ¶ç¡®ä¿å…¼å®¹æ€§
- âŒ APISIX é…ç½®éœ€è¦åˆå¹¶å¤šä¸ª proto

**æ¨èåšæ³•ï¼š**
- **å°å›¢é˜Ÿ/å­¦ä¹ é¡¹ç›®**ï¼šä½¿ç”¨æ–¹æ¡ˆ Aï¼ˆé›†ä¸­å¼ï¼‰
- **å¤§å›¢é˜Ÿ/ç”Ÿäº§ç¯å¢ƒ**ï¼šä½¿ç”¨æ–¹æ¡ˆ Bï¼ˆåˆ†å¸ƒå¼ï¼‰+ Git Submodule æˆ–ç‹¬ç«‹ Proto ä»“åº“

---

### 2. å¾®æœåŠ¡å’Œ APISIX ä¸åœ¨åŒä¸€ç›®å½•ï¼Œå¦‚ä½•ç”Ÿæˆé…ç½®ï¼Ÿ

**ç­”æ¡ˆï¼šé€šè¿‡ Admin API åŠ¨æ€æ¨é€ï¼Œè€Œä¸æ˜¯é™æ€é…ç½®æ–‡ä»¶**

APISIX æ”¯æŒä¸¤ç§é…ç½®æ–¹å¼ï¼š

#### æ–¹å¼ 1ï¼šé™æ€é…ç½®æ–‡ä»¶ï¼ˆå½“å‰æ–¹å¼ï¼‰
```yaml
# apisix/config/apisix.yaml
routes:
  - uri: /api/v1/users/register
    ...
```

**é€‚ç”¨åœºæ™¯ï¼š** å¼€å‘ç¯å¢ƒã€å•æœºéƒ¨ç½²ã€é…ç½®ç®€å•

#### æ–¹å¼ 2ï¼šAdmin API åŠ¨æ€æ¨é€ï¼ˆæ¨èç”¨äºç”Ÿäº§ï¼‰
```bash
# é€šè¿‡è„šæœ¬è°ƒç”¨ Admin API
curl -X PUT http://apisix:9180/apisix/admin/routes/user-register \
  -H "X-API-KEY: ${ADMIN_KEY}" \
  -H "Content-Type: application/json" \
  -d @route-config.json
```

**é€‚ç”¨åœºæ™¯ï¼š** ç”Ÿäº§ç¯å¢ƒã€å¤šç¯å¢ƒã€CI/CD é›†æˆ

---

### 3. æ˜¯å¦éœ€è¦æ¯ä¸ªå¾®æœåŠ¡ç”Ÿæˆä¸åŒçš„ apisix.yamlï¼Ÿ

**ç­”æ¡ˆï¼šä¸éœ€è¦ï¼æ¨èä½¿ç”¨é…ç½®åˆå¹¶ç­–ç•¥**

#### âŒ ä¸æ¨èï¼šæ¯ä¸ªæœåŠ¡ç‹¬ç«‹é…ç½®æ–‡ä»¶
```
user-service/
â””â”€â”€ apisix-user.yaml    # åªåŒ…å« user è·¯ç”±

order-service/
â””â”€â”€ apisix-order.yaml   # åªåŒ…å« order è·¯ç”±
```

**é—®é¢˜ï¼š**
- é…ç½®åˆ†æ•£ï¼Œéš¾ä»¥ç®¡ç†
- è·¯ç”±å†²çªéš¾ä»¥å‘ç°
- æ— æ³•ç»Ÿä¸€ç®¡ç†å…¨å±€é…ç½®

#### âœ… æ¨èï¼šé…ç½®åˆå¹¶ + ç‰ˆæœ¬æ§åˆ¶

**æ–¹æ¡ˆ 1ï¼šé…ç½®ä¸­å¿ƒæ¨¡å¼**
```
apisix-configs/
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ user-routes.yaml
â”‚   â”œâ”€â”€ order-routes.yaml
â”‚   â””â”€â”€ feed-routes.yaml
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ merge-and-push.sh    # åˆå¹¶å¹¶æ¨é€åˆ° etcd
â””â”€â”€ environments/
    â”œâ”€â”€ dev.yaml
    â”œâ”€â”€ staging.yaml
    â””â”€â”€ prod.yaml
```

**æ–¹æ¡ˆ 2ï¼šæ¯ä¸ªæœåŠ¡æä¾›é…ç½®ç‰‡æ®µ**
```
user-service/
â””â”€â”€ apisix/
    â””â”€â”€ routes.yaml      # åªåŒ…å«è‡ªå·±çš„è·¯ç”±å®šä¹‰

# é€šè¿‡ CI/CD åˆå¹¶æ‰€æœ‰æœåŠ¡çš„é…ç½®
```

---

### 4. å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒå¦‚ä½•ç®¡ç†é…ç½®ï¼Ÿ

**ç­”æ¡ˆï¼šç¯å¢ƒåˆ†ç¦» + é…ç½®æ¨¡æ¿**

## é…ç½®ç®¡ç†æ–¹æ¡ˆ

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           é…ç½®ç®¡ç†æµç¨‹                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
   â”‚ å¼€å‘ç¯å¢ƒ  â”‚            â”‚  ç”Ÿäº§ç¯å¢ƒ   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚                       â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚      APISIX Admin API           â”‚
   â”‚      (ç»Ÿä¸€å…¥å£)                 â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚  etcd   â”‚
   â”‚ (é…ç½®ä¸­å¿ƒ)â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å¼€å‘ç¯å¢ƒ | ç”Ÿäº§ç¯å¢ƒ | é€‚ç”¨åœºæ™¯ |
|------|---------|---------|---------|
| **é™æ€æ–‡ä»¶** | âœ… ç®€å•ç›´æ¥ | âŒ éš¾ä»¥ç®¡ç† | å°é¡¹ç›®ã€å­¦ä¹  |
| **Admin API** | âœ… çµæ´» | âœ… æ¨è | ç”Ÿäº§ç¯å¢ƒ |
| **æ··åˆæ¨¡å¼** | é™æ€æ–‡ä»¶ | Admin API | **æ¨è** |

---

## å¼€å‘ç¯å¢ƒå®è·µ

### æ–¹æ¡ˆï¼šé™æ€é…ç½®æ–‡ä»¶ + æœ¬åœ°è„šæœ¬

#### ç›®å½•ç»“æ„
```
uyou-Infrastructure/
â”œâ”€â”€ apisix/
â”‚   â””â”€â”€ config/
â”‚       â”œâ”€â”€ config.yaml          # APISIX åŸºç¡€é…ç½®
â”‚       â””â”€â”€ apisix.yaml          # è·¯ç”±é…ç½®ï¼ˆå¼€å‘ç”¨ï¼‰
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ init-apisix-routes.sh    # åˆå§‹åŒ–è„šæœ¬
â”‚   â””â”€â”€ update-route.sh          # æ›´æ–°å•ä¸ªè·¯ç”±
â””â”€â”€ proto/
    â””â”€â”€ *.proto
```

#### å·¥ä½œæµç¨‹

1. **ä¿®æ”¹ proto æ–‡ä»¶**
   ```bash
   # åœ¨ proto/ ç›®å½•ä¸‹ä¿®æ”¹
   vim proto/user.proto
   ```

2. **ç”Ÿæˆä»£ç **
   ```bash
   make proto
   ```

3. **æ›´æ–° APISIX é…ç½®**
   ```bash
   # æ–¹å¼ 1ï¼šæ‰‹åŠ¨ç¼–è¾‘ apisix.yaml
   vim apisix/config/apisix.yaml
   
   # æ–¹å¼ 2ï¼šä½¿ç”¨è„šæœ¬è‡ªåŠ¨æ›´æ–°ï¼ˆæ¨èï¼‰
   make update-apisix
   ```

4. **é‡å¯æœåŠ¡**
   ```bash
   docker compose restart apisix
   ```

---

## ç”Ÿäº§ç¯å¢ƒå®è·µ

### æ–¹æ¡ˆï¼šé…ç½®å³ä»£ç  + CI/CD

#### ç›®å½•ç»“æ„ï¼ˆå¤šä»“åº“åœºæ™¯ï¼‰

```
# ä»“åº“ 1: Infrastructureï¼ˆAPISIX é…ç½®ä¸­å¿ƒï¼‰
apisix-configs/
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ user-routes.yaml
â”‚   â”œâ”€â”€ order-routes.yaml
â”‚   â””â”€â”€ feed-routes.yaml
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ deploy.sh              # éƒ¨ç½²è„šæœ¬
â”‚   â””â”€â”€ validate-config.sh     # é…ç½®éªŒè¯
â””â”€â”€ environments/
    â”œâ”€â”€ dev/
    â”‚   â””â”€â”€ config.yaml
    â”œâ”€â”€ staging/
    â”‚   â””â”€â”€ config.yaml
    â””â”€â”€ prod/
        â””â”€â”€ config.yaml

# ä»“åº“ 2: user-serviceï¼ˆå¾®æœåŠ¡ï¼‰
user-service/
â”œâ”€â”€ proto/
â”‚   â””â”€â”€ user.proto
â””â”€â”€ apisix/
    â””â”€â”€ routes.yaml            # è·¯ç”±å®šä¹‰ï¼ˆä¾› Infrastructure å¼•ç”¨ï¼‰

# ä»“åº“ 3: order-service
order-service/
â”œâ”€â”€ proto/
â”‚   â””â”€â”€ order.proto
â””â”€â”€ apisix/
    â””â”€â”€ routes.yaml
```

#### å·¥ä½œæµç¨‹

1. **å¾®æœåŠ¡å¼€å‘**
   ```bash
   # åœ¨ user-service ä»“åº“
   # 1. ä¿®æ”¹ proto
   vim proto/user.proto
   
   # 2. æ›´æ–°è·¯ç”±é…ç½®
   vim apisix/routes.yaml
   
   # 3. æäº¤ PR
   git push origin feature/new-api
   ```

2. **é…ç½®åˆå¹¶ï¼ˆCI/CDï¼‰**
   ```bash
   # Infrastructure ä»“åº“çš„ CI æµç¨‹
   # 1. æ‹‰å–æ‰€æœ‰å¾®æœåŠ¡çš„é…ç½®
   git submodule update --remote
   
   # 2. åˆå¹¶é…ç½®
   ./scripts/merge-configs.sh
   
   # 3. éªŒè¯é…ç½®
   ./scripts/validate-config.sh
   
   # 4. æ¨é€åˆ° APISIX
   ./scripts/deploy.sh --env prod
   ```

3. **éƒ¨ç½²è„šæœ¬ç¤ºä¾‹**
   ```bash
   # scripts/deploy.sh
   #!/bin/bash
   ENV=${1:-dev}
   APISIX_ADMIN="http://apisix-${ENV}:9180"
   ADMIN_KEY="${APISIX_ADMIN_KEY}"
   
   # åˆå¹¶æ‰€æœ‰è·¯ç”±é…ç½®
   cat routes/*.yaml > merged-routes.yaml
   
   # è½¬æ¢ä¸º JSON å¹¶æ¨é€
   yq eval -o=json merged-routes.yaml | \
     jq -c '.routes[]' | \
     while read route; do
       route_id=$(echo $route | jq -r '.name')
       curl -X PUT "${APISIX_ADMIN}/apisix/admin/routes/${route_id}" \
         -H "X-API-KEY: ${ADMIN_KEY}" \
         -H "Content-Type: application/json" \
         -d "$route"
     done
   ```

---

## æœ€ä½³å®è·µå»ºè®®

### 1. Proto æ–‡ä»¶ç®¡ç†

#### âœ… æ¨èåšæ³•

**å°å›¢é˜Ÿï¼ˆ< 5äººï¼‰ï¼š**
- é›†ä¸­ç®¡ç†ï¼šæ‰€æœ‰ proto æ”¾åœ¨ `proto/` ç›®å½•
- ä½¿ç”¨ Git Submodule æˆ–ç‹¬ç«‹ä»“åº“å…±äº«

**å¤§å›¢é˜Ÿï¼ˆ> 5äººï¼‰ï¼š**
- åˆ†å¸ƒå¼ç®¡ç†ï¼šæ¯ä¸ªæœåŠ¡ç®¡ç†è‡ªå·±çš„ proto
- ä½¿ç”¨ Proto Registryï¼ˆå¦‚ Buf Schema Registryï¼‰
- å»ºç«‹ API ç‰ˆæœ¬ç®¡ç†è§„èŒƒ

#### ğŸ“ ç¤ºä¾‹ï¼šä½¿ç”¨ Git Submodule

```bash
# åœ¨ Infrastructure ä»“åº“
git submodule add https://github.com/your-org/proto-definitions.git proto

# åœ¨å¾®æœåŠ¡ä»“åº“
git submodule add https://github.com/your-org/proto-definitions.git proto
```

### 2. APISIX é…ç½®ç®¡ç†

#### âœ… æ¨èåšæ³•

**å¼€å‘ç¯å¢ƒï¼š**
```yaml
# ä½¿ç”¨é™æ€æ–‡ä»¶ï¼Œç®€å•ç›´æ¥
apisix/config/apisix.yaml
```

**ç”Ÿäº§ç¯å¢ƒï¼š**
```bash
# ä½¿ç”¨ Admin API + é…ç½®ç‰ˆæœ¬æ§åˆ¶
# 1. é…ç½®å­˜å‚¨åœ¨ Git
# 2. CI/CD è‡ªåŠ¨éƒ¨ç½²
# 3. æ”¯æŒå›æ»š
```

#### ğŸ“ é…ç½®æ¨¡æ¿

```yaml
# routes/user-routes.yaml
routes:
  - name: user-register
    uri: /api/v1/users/register
    methods: [POST]
    upstream:
      nodes:
        "${USER_SERVICE_HOST}:${USER_SERVICE_PORT}": 1
    plugins:
      grpc-transcode:
        proto_id: "1"
        service: user.UserService
        method: Register
```

### 3. ç¯å¢ƒç®¡ç†

#### âœ… æ¨èåšæ³•

```bash
# ä½¿ç”¨ç¯å¢ƒå˜é‡ + é…ç½®æ¨¡æ¿
APISIX_ADMIN_URL=http://apisix-prod:9180
APISIX_ADMIN_KEY=your-secret-key
USER_SERVICE_HOST=user-service.prod.svc.cluster.local
USER_SERVICE_PORT=50051
```

#### ğŸ“ ç¯å¢ƒé…ç½®æ–‡ä»¶

```yaml
# environments/prod/config.yaml
apisix:
  admin_url: http://apisix-prod:9180
  admin_key: ${APISIX_ADMIN_KEY}

services:
  user:
    host: user-service.prod.svc.cluster.local
    port: 50051
  order:
    host: order-service.prod.svc.cluster.local
    port: 50052
```

### 4. é…ç½®éªŒè¯

#### âœ… æ¨èåšæ³•

```bash
# éƒ¨ç½²å‰éªŒè¯é…ç½®
./scripts/validate-config.sh

# æ£€æŸ¥é¡¹ï¼š
# 1. YAML è¯­æ³•æ­£ç¡®
# 2. è·¯ç”±ä¸å†²çª
# 3. Upstream å¯è¾¾
# 4. Proto å®šä¹‰å­˜åœ¨
```

---

## æ€»ç»“

### å¿«é€Ÿå†³ç­–æ ‘

```
å¾®æœåŠ¡æ˜¯å¦ç‹¬ç«‹ä»“åº“ï¼Ÿ
â”œâ”€ å¦ â†’ é›†ä¸­å¼ç®¡ç†ï¼ˆå½“å‰æ–¹æ¡ˆï¼‰
â”‚       â””â”€ proto/ ç›®å½• + é™æ€é…ç½®æ–‡ä»¶
â”‚
â””â”€ æ˜¯ â†’ åˆ†å¸ƒå¼ç®¡ç†
    â”œâ”€ å¼€å‘ç¯å¢ƒï¼šé™æ€æ–‡ä»¶ + è„šæœ¬
    â””â”€ ç”Ÿäº§ç¯å¢ƒï¼šAdmin API + CI/CD
        â”œâ”€ æ¯ä¸ªæœåŠ¡æä¾›é…ç½®ç‰‡æ®µ
        â”œâ”€ Infrastructure ä»“åº“åˆå¹¶é…ç½®
        â””â”€ è‡ªåŠ¨éƒ¨ç½²åˆ° APISIX
```

### æ ¸å¿ƒåŸåˆ™

1. **å¼€å‘ç¯å¢ƒ**ï¼šç®€å•ä¼˜å…ˆï¼Œä½¿ç”¨é™æ€é…ç½®
2. **ç”Ÿäº§ç¯å¢ƒ**ï¼šçµæ´»ä¼˜å…ˆï¼Œä½¿ç”¨ Admin API
3. **é…ç½®ç®¡ç†**ï¼šç‰ˆæœ¬æ§åˆ¶ + è‡ªåŠ¨åŒ–éƒ¨ç½²
4. **å›¢é˜Ÿåä½œ**ï¼šæ˜ç¡®èŒè´£ï¼Œé¿å…å†²çª

---

## ä¸‹ä¸€æ­¥

1. æ ¹æ®å›¢é˜Ÿè§„æ¨¡é€‰æ‹©æ–¹æ¡ˆ
2. è®¾ç½® CI/CD æµç¨‹
3. å»ºç«‹é…ç½®ç®¡ç†è§„èŒƒ
4. æ–‡æ¡£åŒ–é…ç½®å˜æ›´æµç¨‹

å¦‚æœ‰ç–‘é—®ï¼Œè¯·å‚è€ƒï¼š
- [RUN.md](./RUN.md) - è¿è¡ŒæŒ‡å—
- [TUTORIAL.md](./TUTORIAL.md) - å®Œæ•´æ•™ç¨‹
