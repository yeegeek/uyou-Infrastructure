name: Deploy APISIX Configuration

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'apisix/config/routes/**'
      - 'services/**'
      - '.github/workflows/deploy-apisix.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: '部署环境'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
  # 监听微服务仓库的更新（通过 repository_dispatch）
  repository_dispatch:
    types: [routes-updated]

env:
  PYTHON_VERSION: '3.11'

jobs:
  sync-and-validate:
    name: 同步并验证配置
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      
      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: 安装依赖
        run: |
          pip install pyyaml
      
      - name: 更新 Submodules
        run: |
          git submodule update --init --recursive
          git submodule update --remote
      
      - name: 同步路由配置
        run: |
          ./scripts/sync-routes.sh
      
      - name: 验证配置
        run: |
          ./scripts/validate-config.sh
      
      - name: 提交同步的配置
        if: github.event_name == 'push' || github.event_name == 'repository_dispatch'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          if [ -n "$(git status --porcelain apisix/config/routes/)" ]; then
            git add apisix/config/routes/
            git commit -m "chore: sync routes from microservices [skip ci]" || exit 0
            git push
          fi
  
  deploy:
    name: 部署到 APISIX
    needs: sync-and-validate
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'repository_dispatch'
    
    strategy:
      matrix:
        environment: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: 设置环境变量
        run: |
          if [ "${{ matrix.environment }}" == "prod" ]; then
            echo "APISIX_ADMIN_URL=${{ secrets.APISIX_ADMIN_URL_PROD }}" >> $GITHUB_ENV
            echo "APISIX_ADMIN_KEY=${{ secrets.APISIX_ADMIN_KEY_PROD }}" >> $GITHUB_ENV
            echo "APISIX_ENV=prod" >> $GITHUB_ENV
          elif [ "${{ matrix.environment }}" == "staging" ]; then
            echo "APISIX_ADMIN_URL=${{ secrets.APISIX_ADMIN_URL_STAGING }}" >> $GITHUB_ENV
            echo "APISIX_ADMIN_KEY=${{ secrets.APISIX_ADMIN_KEY_STAGING }}" >> $GITHUB_ENV
            echo "APISIX_ENV=staging" >> $GITHUB_ENV
          else
            echo "APISIX_ADMIN_URL=${{ secrets.APISIX_ADMIN_URL_DEV || 'http://localhost:9180' }}" >> $GITHUB_ENV
            echo "APISIX_ADMIN_KEY=${{ secrets.APISIX_ADMIN_KEY_DEV || 'edd1c9f034335f136f87ad84b625c8f1' }}" >> $GITHUB_ENV
            echo "APISIX_ENV=dev" >> $GITHUB_ENV
          fi
      
      - name: 部署配置到 APISIX
        run: |
          ./scripts/merge-apisix-configs.sh
      
      - name: 验证部署
        run: |
          echo "验证 APISIX 配置..."
          curl -s -f "${APISIX_ADMIN_URL}/apisix/admin/routes" \
            -H "X-API-KEY: ${APISIX_ADMIN_KEY}" | jq '.list' || echo "警告: 无法验证配置"
